---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog', ({ data }: any) => {
    return data.draft !== true;
  });
  return blogEntries.map((entry: CollectionEntry<'blog'>) => ({
    params: { slug: entry.slug }, 
    props: { entry },
  }));
}

interface Props {
  entry: CollectionEntry<'blog'>;
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// Get related posts (same category, excluding current post)
const allPosts = await getCollection('blog', ({ data }: any) => {
  return data.draft !== true;
});

const relatedPosts = allPosts
  .filter((post: CollectionEntry<'blog'>) => post.data.category === entry.data.category && post.slug !== entry.slug)
  .slice(0, 3);

// Format date for display
function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long'
  }).format(date);
}
---

<BaseLayout title={entry.data.title} description={entry.data.description}>
  <!-- banner -->
  <div class="mil-inner-banner mil-p-0-120">
    <div class="mil-banner-content mil-center mil-up">
      <div class="container">
        <ul class="mil-breadcrumbs mil-center mil-mb-60">
          <li><a href="/">Homepage</a></li>
          <li><a href="/blog">Blog</a></li>
          <li><a href={`/blog/${entry.slug}`}>Publication</a></li>
        </ul>
        <h2>{entry.data.title}</h2>
      </div>
    </div>
  </div>
  <!-- banner end -->

  <!-- publication -->
  <section id="blog">
    <div class="container mil-p-120-90">
      <div class="row justify-content-center">
        <div class="col-lg-12">

          <div class="mil-image-frame mil-horizontal mil-up">
            <img src={entry.data.image} alt={entry.data.imageAlt || entry.data.title} class="mil-scale" data-value-1=".90" data-value-2="1.15">
          </div>
          <div class="mil-info mil-up mil-mb-90">
            <div>Category: &nbsp;<span class="mil-dark">{entry.data.category}</span></div>
            <div>Date: &nbsp;<span class="mil-dark">{formatDate(entry.data.pubDate)}</span></div>
            <div>Author: &nbsp;<span class="mil-dark">{entry.data.author}</span></div>
          </div>

        </div>
        <div class="col-lg-8">

          <p class="mil-text-xl mil-dark mil-up mil-mb-60">{entry.data.description}</p>

          <div class="mil-up mil-mb-60">
            <Content />
          </div>

        </div>
      </div>
    </div>
  </section>
  <!-- publication end -->

  <!-- similar -->
  {relatedPosts.length > 0 && (
    <section class="mil-soft-bg">
      <div class="container mil-p-120-60">
        <div class="row align-items-center mil-mb-30">
          <div class="col-lg-6 mil-mb-30">
            <h3 class="mil-up">Similar Publications:</h3>
          </div>
          <div class="col-lg-6 mil-mb-30">
            <div class="mil-adaptive-right mil-up">
              <a href="/blog" class="mil-link mil-dark mil-arrow-place">
                <span>View all</span>
              </a>
            </div>
          </div>
        </div>
        <div class="row">
          {relatedPosts.map((post: CollectionEntry<'blog'>) => (
            <div class="col-lg-6">

              <a href={`/blog/${post.slug}`} class="mil-blog-card mil-mb-60">
                <div class="mil-cover-frame mil-up">
                  <img src={post.data.image} alt={post.data.imageAlt || post.data.title}>
                </div>
                <div class="mil-post-descr">
                  <div class="mil-labels mil-up mil-mb-30">
                    <div class="mil-label mil-upper mil-accent">{post.data.category}</div>
                    <div class="mil-label mil-upper">{formatDate(post.data.pubDate)}</div>
                  </div>
                  <h4 class="mil-up mil-mb-30">{post.data.title}</h4>
                  <p class="mil-post-text mil-up mil-mb-30">{post.data.description.length > 150 ? post.data.description.substring(0, 150) + '...' : post.data.description}</p>
                  <div class="mil-link mil-dark mil-arrow-place mil-up">
                    <span>Read more</span>
                  </div>
                </div>
              </a>

            </div>
          ))}
        </div>
      </div>
    </section>
  )}
  <!-- similar end -->

</BaseLayout>

<style>
/* Dynamic markdown content styling to match publication.html structure */
.col-lg-8 :global(h1),
.col-lg-8 :global(h2),
.col-lg-8 :global(h3),
.col-lg-8 :global(h4),
.col-lg-8 :global(h5),
.col-lg-8 :global(h6) {
  @apply mil-up mil-mb-30;
}

.col-lg-8 :global(p) {
  @apply mil-up mil-mb-60;
}

.col-lg-8 :global(blockquote) {
  @apply mil-up mil-mb-60;
  padding: 1.5rem;
  font-style: italic;
  position: relative;
}

.col-lg-8 :global(blockquote::before) {
  content: '"';
  font-size: 4rem;
  position: absolute;
  left: 0;
  top: -10px;
  opacity: 0.3;
}

.col-lg-8 :global(ul),
.col-lg-8 :global(ol) {
  @apply mil-up mil-mb-60;
  padding-left: 2rem;
}

.col-lg-8 :global(li) {
  margin-bottom: 0.5rem;
}

.col-lg-8 :global(strong) {
  font-weight: 600;
}

.col-lg-8 :global(em) {
  font-style: italic;
}

/* Images in content */
.col-lg-8 :global(img) {
  @apply mil-up mil-mb-60;
  width: 100%;
  height: auto;
  border-radius: 8px;
}

/* Code blocks */
.col-lg-8 :global(code) {
  background: #f5f5f5;
  padding: 0.2rem 0.4rem;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  font-size: 0.9rem;
}

.col-lg-8 :global(pre) {
  @apply mil-up mil-mb-60;
  background: #f5f5f5;
  padding: 1.5rem;
  border-radius: 8px;
  overflow-x: auto;
}

.col-lg-8 :global(pre code) {
  background: none;
  padding: 0;
}

/* Horizontal rules */
.col-lg-8 :global(hr) {
  @apply mil-up mil-mb-60;
  border: none;
  height: 1px;
  background: #e0e0e0;
}

/* Tables */
.col-lg-8 :global(table) {
  @apply mil-up mil-mb-60;
  width: 100%;
  border-collapse: collapse;
}

.col-lg-8 :global(th),
.col-lg-8 :global(td) {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid #e0e0e0;
}

.col-lg-8 :global(th) {
  font-weight: 600;
  background: #f9f9f9;
}
</style>

